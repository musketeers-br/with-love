Class dc.withLove.engine.FHIRHandler Extends %RegisteredObject
{

/// Validates the FHIR JSON generated by AI
ClassMethod ValidateAndProcess(pJsonStream As %Stream.GlobalCharacter) As %DynamicObject
{
    Set tResponse = {}
    
    Try {
        // 1. Parse JSON to ensure syntax validity
        Set tDynamicObj = {}.%FromJSON(pJsonStream)
        
        // 2. Check if it is a Bundle
        If (tDynamicObj.resourceType '= "Bundle") {
            $$$ThrowStatus($$$ERROR($$$GeneralError, "AI generated a " _ tDynamicObj.resourceType _ ", expected a Bundle."))
        }

        // 3. (Optional) Here you would call the Internal FHIR Service to save
        // For the MVP, we return the validated object to show in the UI
        // Example logic to save:
        // Set tSC = ##class(HS.FHIRServer.Service).EnsureInstance(namespace).ProcessBundle(tDynamicObj)
        
        Set tResponse = tDynamicObj
        
    } Catch ex {
        Set tResponse = {
            "resourceType": "OperationOutcome",
            "issue": [{
                "severity": "error",
                "code": "processing",
                "diagnostics": (ex.DisplayString())
            }]
        }
    }
    
    Return tResponse
}

}
