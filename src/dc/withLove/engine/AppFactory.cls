Class dc.withLove.engine.AppFactory Extends %RegisteredObject
{

ClassMethod CreateApp(pTenantId As %String, pAppName As %String, pHtmlContent As %String, pPrompt As %String = "", pModel As %String = "manual") As %String
{
    Set tAppUrl = ""
    Try {
        TSTART
        
        // --- 1. SANITIZATION (App Name & Tenant) ---
        Set tCleanName = $ZStrip(pAppName, "*E", "", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")
        If $IsValidNum($Extract(tCleanName,1)) Set tCleanName = "App"_tCleanName
        If tCleanName="" Set tCleanName = "GeneratedApp"_$Random(10000)
        
        Set tCleanTenant = $ZStrip(pTenantId, "*E", "", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")
        If tCleanTenant="" Set tCleanTenant = "default"
        
        // --- 2. STORAGE ---
        Set tProjId = ""
        &sql(SELECT ID INTO :tProjId FROM dc_withLove_storage.Project WHERE TenantID = :pTenantId AND CodeName = :tCleanName)
        
        If (tProjId = "") {
            Set tProj = ##class(dc.withLove.storage.Project).%New()
            Set tProj.TenantID = pTenantId
            Set tProj.Name = pAppName 
            Set tProj.CodeName = tCleanName
            Set tProj.Description = "Generated by withLove"
        } Else {
            Set tProj = ##class(dc.withLove.storage.Project).%OpenId(tProjId)
        }
        
        Set tProj.CurrentVersion = tProj.CurrentVersion + 1
        Set tVersion = ##class(dc.withLove.storage.AppVersion).%New()
        Set tVersion.VersionNumber = tProj.CurrentVersion
        Set tVersion.PromptUsed = pPrompt
        Set tVersion.LLMModel = pModel
        Do tVersion.SourceCode.Write(pHtmlContent)
        Do tVersion.ProjectSetObjectId(tProj.%Id())
        Do tProj.Versions.Insert(tVersion)
        Do tProj.%Save()
        
        // --- 3. CLASS GENERATION (Multi-Tenant Package) ---
        // Target: dc.withLove.<Tenant>.apps.<AppName>
        Set tClassName = "dc.withLove." _ tCleanTenant _ ".apps." _ tCleanName
        
        If ##class(%Dictionary.ClassDefinition).%ExistsId(tClassName) {
            Do $System.OBJ.Delete(tClassName, "-d") 
        }
        
        Set tClassDef = ##class(%Dictionary.ClassDefinition).%New(tClassName)
        Set tClassDef.Super = "%CSP.Page"
        
        Set tParam = ##class(%Dictionary.ParameterDefinition).%New()
        Set tParam.Name = "CHARSET"
        Set tParam.Default = "utf-8"
        Do tClassDef.Parameters.Insert(tParam)

        Set tMethod = ##class(%Dictionary.MethodDefinition).%New()
        Set tMethod.Name = "OnPage"
        Set tMethod.ClassMethod = 1
        Set tMethod.ReturnType = "%Status"
        
        Do tMethod.Implementation.WriteLine("  // Generated by withLove for Tenant: "_tCleanTenant)
        
        Set tCleanHtml = $Replace(pHtmlContent, $C(13,10), $C(10))
        Set tLen = $Length(tCleanHtml, $C(10))
        
        For i=1:1:tLen {
            Set tLine = $Piece(tCleanHtml, $C(10), i)
            Continue:tLine=""
            Set tEscapedLine = $Replace(tLine, """", """""")
            Do tMethod.Implementation.WriteLine("  Write """ _ tEscapedLine _ """,!")
        }
        
        Do tMethod.Implementation.WriteLine("  Quit $$$OK")
        Do tClassDef.Methods.Insert(tMethod)
        
        Set tSC = tClassDef.%Save()
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        Set tSC = $System.OBJ.Compile(tClassName, "ck-d", .tErrLog)
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        TCOMMIT
        
        Set tAppUrl = "/csp/"_$Namespace_"/"_tClassName_".cls"
        
    } Catch ex {
        TROLLBACK
        Set tAppUrl = "ERROR: " _ ex.DisplayString()
    }
    Return tAppUrl
}

}
