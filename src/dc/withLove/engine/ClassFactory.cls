Class dc.withLove.engine.ClassFactory Extends %RegisteredObject
{

/// Deploys a persistent class generated by AI directly into the IRIS Database.
/// Enforces Multi-Tenancy by injecting the Tenant ID into the package name.
ClassMethod DeployBackend(pSourceCode As %String, pTenantId As %String) As %String
{
    Set tResult = ""
    Try {
        // --- 1. TENANT SANITIZATION ---
        // Ensure Tenant ID is safe for package names (Alphanumeric only)
        Set tCleanTenant = $ZStrip(pTenantId, "*E", "", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")
        If tCleanTenant = "" Set tCleanTenant = "default"
        
        // Define the Target Package for this User
        Set tTargetPackage = "dc.withLove." _ tCleanTenant _ ".data"

        // --- 2. CODE SANITIZATION ---
        Set pSourceCode = $Replace(pSourceCode, "```objectscript", "")
        Set pSourceCode = $Replace(pSourceCode, "```", "")
        
        // Cut Storage block if present
        If (pSourceCode [ "Storage Default") {
            Set pSourceCode = $Piece(pSourceCode, "Storage Default", 1)
            If $Extract($ZStrip(pSourceCode,">W"), *) '= "}" {
                Set pSourceCode = pSourceCode _ $C(10) _ "}"
            }
        }

        // --- 3. CLASS NAME & PACKAGE INJECTION ---
        Set tMatcher = ##class(%Regex.Matcher).%New("Class\s+([\w\.]+)\s+Extends")
        Set tMatcher.Text = pSourceCode
        
        If 'tMatcher.Locate() {
            Set tMatcher = ##class(%Regex.Matcher).%New("Class\s+([\w\.]+)")
            Set tMatcher.Text = pSourceCode
            If 'tMatcher.Locate() Throw ##class(%Exception.General).%New("Parser", 500, , "Could not identify Class Name.")
        }
        Set tOldClassName = tMatcher.Group(1)
        
        // Force the new Multi-Tenant Package
        // Example: changes 'dc.withLove.data.Patient' to 'dc.withLove.UserXY.data.Patient'
        Set tShortName = $Piece(tOldClassName, ".", *)
        Set tNewClassName = tTargetPackage _ "." _ tShortName
        
        // Replace in source
        Set pSourceCode = $Replace(pSourceCode, tOldClassName, tNewClassName)
        Set tClassName = tNewClassName

        // --- 4. CLEANUP & COMPILE ---
        If ##class(%Dictionary.ClassDefinition).%ExistsId(tClassName) {
            Do $System.OBJ.Delete(tClassName, "-d")
        }
        
        Set tStream = ##class(%Stream.GlobalCharacter).%New()
        Do tStream.Write(pSourceCode)
        Do tStream.Rewind()
        
        Set tSC = $System.OBJ.LoadStream(tStream, "c-d", .tErr)
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        Set tSC = $System.OBJ.Compile(tClassName, "ck-d", .tErr)
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        // --- 5. RESULT ---
        Set tTable = ##class(%DeepSee.Utils).%GetSQLTableName(tClassName)
        If tTable="" Set tTable = $Replace(tClassName,".","_")
        
        Set tResult = tTable
        
    } Catch ex {
        Set tResult = "ERROR: " _ ex.DisplayString()
    }
    Return tResult
}

}
