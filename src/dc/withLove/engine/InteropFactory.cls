Class dc.withLove.engine.InteropFactory Extends %RegisteredObject
{

/// Compiles Interoperability Components (DTL, BO, BS) generated by AI.
/// Enforces Multi-Tenancy package: dc.withLove.<tenant>.interop
ClassMethod DeployComponent(pSourceCode As %String, pTenantId As %String) As %String
{
    Set tResult = ""
    Try {
        // 1. Sanitization
        Set pSourceCode = $Replace(pSourceCode, "```objectscript", "")
        Set pSourceCode = $Replace(pSourceCode, "```xml", "") 
        Set pSourceCode = $Replace(pSourceCode, "```", "")
        
        If (pSourceCode [ "<transform") && (pSourceCode '[ "xmlns:xsi") {
            Set pSourceCode = $Replace(pSourceCode, "<transform", "<transform xmlns:xsi=""[http://www.w3.org/2001/XMLSchema-instance](http://www.w3.org/2001/XMLSchema-instance)""")
        }

        Set tMatcher = ##class(%Regex.Matcher).%New("Class\s+([\w\.]+)\s+Extends")
        Set tMatcher.Text = pSourceCode
        If 'tMatcher.Locate() Throw ##class(%Exception.General).%New("Parser", 500, , "Could not identify Class Name.")
        Set tOriginalName = tMatcher.Group(1)
        
        // 3. Package Enforcement: dc.withLove.<Tenant>.interop
        Set tCleanTenant = $ZStrip(pTenantId, "*E", "", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")
        If tCleanTenant="" Set tCleanTenant = "default"
        
        Set tPkg = "dc.withLove." _ tCleanTenant _ ".interop"
        Set tShortName = $Piece(tOriginalName, ".", *)
        Set tNewName = tPkg _ "." _ tShortName
        
        // Replace class name in source
        Set pSourceCode = $Replace(pSourceCode, tOriginalName, tNewName)
        
        // 4. Cleanup Previous Version
        If ##class(%Dictionary.ClassDefinition).%ExistsId(tNewName) {
            Do $System.OBJ.Delete(tNewName, "-d")
        }
        
        // 5. Load and Compile
        Set tStream = ##class(%Stream.GlobalCharacter).%New()
        Do tStream.Write(pSourceCode)
        Do tStream.Rewind()
        
        // 'c' = Compile, 'k' = Keep source, '-d' = Silent
        Set tSC = $System.OBJ.LoadStream(tStream, "ck-d", .tErr)
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        Set tResult = tNewName
        
    } Catch ex {
        Set tResult = "ERROR: " _ ex.DisplayString()
    }
    Return tResult
}

}
