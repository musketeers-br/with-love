Class dc.withLove.engine.ApiFactory Extends %RegisteredObject
{

/// Compiles and Deploys a REST API Class generated by the AI.
/// Enforces Multi-Tenancy by placing the class in 'dc.withLove.<tenant>.api'.
ClassMethod DeployApi(pSourceCode As %String, pTenantId As %String) As %String
{
    Set tResult = ""
    Try {
        // 1. Sanitization: Remove Markdown blocks
        Set pSourceCode = $Replace(pSourceCode, "```objectscript", "")
        Set pSourceCode = $Replace(pSourceCode, "```", "")
        
        // 2. Extract Original Class Name
        Set tMatcher = ##class(%Regex.Matcher).%New("Class\s+([\w\.]+)\s+Extends")
        Set tMatcher.Text = pSourceCode
        If 'tMatcher.Locate() Throw ##class(%Exception.General).%New("Parser", 500, , "Could not identify Class Name.")
        Set tOriginalName = tMatcher.Group(1)
        
        // 3. Package Enforcement (Multi-Tenancy)
        // Target: dc.withLove.<Tenant>.api.<ServiceName>
        Set tCleanTenant = $ZStrip(pTenantId, "*E", "", "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789")
        If tCleanTenant="" Set tCleanTenant = "default"
        
        Set tPkg = "dc.withLove." _ tCleanTenant _ ".api"
        Set tShortName = $Piece(tOriginalName, ".", *)
        Set tNewName = tPkg _ "." _ tShortName
        
        // Replace class name in source code
        Set pSourceCode = $Replace(pSourceCode, tOriginalName, tNewName)
        
        // 4. Cleanup Previous Version
        If ##class(%Dictionary.ClassDefinition).%ExistsId(tNewName) {
            Do $System.OBJ.Delete(tNewName, "-d")
        }
        
        // 5. Load and Compile
        Set tStream = ##class(%Stream.GlobalCharacter).%New()
        Do tStream.Write(pSourceCode)
        Do tStream.Rewind()
        
        // Compile silently (-d) to avoid breaking JSON response
        Set tSC = $System.OBJ.LoadStream(tStream, "ck-d", .tErr)
        If $$$ISERR(tSC) Throw ##class(%Exception.StatusException).CreateFromStatus(tSC)
        
        Set tResult = tNewName
        
    } Catch ex {
        Set tResult = "ERROR: " _ ex.DisplayString()
    }
    Return tResult
}

}
